# Helper workflow to generate Unity license file (.ulf)
#
# SECURITY NOTE: This workflow does NOT upload license files as artifacts.
# License files are sensitive and should never be publicly accessible.
#
# For manual activation:
#   1. Run this workflow - it outputs the ALF content to logs (safe, it's just a request)
#   2. Copy the ALF content and save locally as .alf file
#   3. Upload to https://license.unity3d.com/manual
#   4. Download the .ulf and set as secret: gh secret set UNITY_LICENSE < file.ulf

name: Generate Unity License

on:
  workflow_dispatch:
    inputs:
      activation_method:
        description: 'Activation method'
        required: true
        default: 'manual'
        type: choice
        options:
          - manual
          - automatic

jobs:
  generate-license:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =========================================================================
      # MANUAL METHOD: Generate .alf and output to logs (safe - ALF is not sensitive)
      # =========================================================================
      - name: Generate activation request (.alf)
        if: inputs.activation_method == 'manual'
        run: |
          echo "Generating Unity activation request file..."

          docker run --rm -v $PWD:/output \
            unityci/editor:ubuntu-2022.3.61f1-linux-il2cpp-3 \
            bash -c "
              unity-editor -batchmode -createManualActivationFile -logfile /dev/stdout -nographics || true
              cp /*.alf /output/ 2>/dev/null || true
              find / -name '*.alf' -exec cp {} /output/ \; 2>/dev/null || true
            "

          # Check if ALF was generated
          if ls *.alf 1>/dev/null 2>&1; then
            echo ""
            echo "=========================================="
            echo "  ALF FILE GENERATED SUCCESSFULLY"
            echo "=========================================="
            echo ""
            echo "Copy the content below and save as 'Unity_v2022.alf':"
            echo ""
            echo "--- BEGIN ALF FILE ---"
            cat *.alf
            echo ""
            echo "--- END ALF FILE ---"
            echo ""
          else
            echo "ERROR: No .alf file was generated"
            exit 1
          fi

      - name: Manual activation instructions
        if: inputs.activation_method == 'manual'
        run: |
          echo ""
          echo "=========================================="
          echo "  NEXT STEPS"
          echo "=========================================="
          echo ""
          echo "1. Copy the ALF content from the logs above"
          echo "2. Save it locally as 'Unity_v2022.alf'"
          echo "3. Go to: https://license.unity3d.com/manual"
          echo "4. Upload the .alf file"
          echo ""
          echo "   NOTE: If 'Personal' option is hidden:"
          echo "   - Press F12 to open DevTools"
          echo "   - Go to Elements tab, search for 'option-personal'"
          echo "   - Remove 'style=\"display: none;\"' from that div"
          echo ""
          echo "5. Download the generated .ulf file"
          echo "6. Set it as a secret (DO NOT commit or upload it!):"
          echo ""
          echo "   gh secret set UNITY_LICENSE --repo ${{ github.repository }} < Unity_v2022.x.ulf"
          echo ""
          echo "=========================================="

      # =========================================================================
      # AUTOMATIC METHOD: Try to activate and set secret directly
      # =========================================================================
      - name: Attempt automatic activation
        if: inputs.activation_method == 'automatic'
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attempting automatic Unity license activation..."
          echo "Note: This may fail if you have 2FA enabled"

          docker run --rm \
            -e UNITY_EMAIL="$UNITY_EMAIL" \
            -e UNITY_PASSWORD="$UNITY_PASSWORD" \
            -v $PWD:/output \
            unityci/editor:ubuntu-2022.3.61f1-linux-il2cpp-3 \
            bash -c "
              unity-editor -batchmode -nographics -logfile /dev/stdout \
                -username \"\$UNITY_EMAIL\" \
                -password \"\$UNITY_PASSWORD\" \
                -quit || true
              cp /root/.local/share/unity3d/Unity/*.ulf /output/ 2>/dev/null || true
              find /root -name '*.ulf' -exec cp {} /output/ \; 2>/dev/null || true
            "

          # Check if ULF was generated
          if ls *.ulf 1>/dev/null 2>&1; then
            echo ""
            echo "License file generated! Setting as secret..."
            echo ""
            # Set the secret directly - NEVER output the content
            gh secret set UNITY_LICENSE --repo ${{ github.repository }} < *.ulf
            echo ""
            echo "SUCCESS: UNITY_LICENSE secret has been set!"
            echo ""
            # Clean up immediately
            rm -f *.ulf
          else
            echo ""
            echo "ERROR: Automatic activation failed."
            echo "This usually happens with 2FA enabled."
            echo "Please use the 'manual' method instead."
            exit 1
          fi

      - name: Security reminder
        run: |
          echo ""
          echo "=========================================="
          echo "  SECURITY REMINDER"
          echo "=========================================="
          echo ""
          echo "- NEVER commit .ulf files to the repository"
          echo "- NEVER upload .ulf files as artifacts"
          echo "- NEVER share your license file publicly"
          echo ""
          echo "The .ulf file is stored only as a GitHub Secret"
          echo "(encrypted and never visible in logs)"
          echo "=========================================="
