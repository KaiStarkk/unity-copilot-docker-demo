# Helper workflow to generate Unity license files
#
# ============================================================================
# SECURITY NOTES
# ============================================================================
#
# Both ALF and ULF files contain sensitive information:
#
# - ALF (Activation License File): Contains machine fingerprint data.
#   While it requires your Unity account to convert to a ULF, it still
#   exposes machine identifiers. Treat as sensitive.
#
# - ULF (Unity License File): The actual license. Combined with your
#   Unity credentials, this grants access to Unity. Highly sensitive.
#
# This workflow:
# - Uploads ALF as a SHORT-LIVED artifact (1 day retention)
# - NEVER uploads or logs ULF content
# - Sets ULF directly as a GitHub Secret
#
# RECOMMENDATION: For public repos, temporarily make the repo private
# while running this workflow, then delete artifacts before making public.
#
# ============================================================================

name: Generate Unity License

on:
  workflow_dispatch:
    inputs:
      activation_method:
        description: 'Activation method'
        required: true
        default: 'manual'
        type: choice
        options:
          - manual
          - automatic

jobs:
  generate-license:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Security warning
        run: |
          echo "=============================================="
          echo "  SECURITY WARNING"
          echo "=============================================="
          echo ""
          echo "License files contain sensitive machine data."
          echo ""
          echo "For PUBLIC repositories:"
          echo "  1. Consider making repo PRIVATE before running"
          echo "  2. Download artifacts immediately after completion"
          echo "  3. Delete artifacts from the workflow run"
          echo "  4. Then make repo public again if needed"
          echo ""
          echo "=============================================="

      # =========================================================================
      # MANUAL METHOD: Generate .alf as short-lived artifact
      # =========================================================================
      - name: Generate activation request (.alf)
        if: inputs.activation_method == 'manual'
        run: |
          echo "Generating Unity activation request file..."

          docker run --rm -v $PWD:/output \
            unityci/editor:ubuntu-2022.3.61f1-linux-il2cpp-3 \
            bash -c "
              unity-editor -batchmode -createManualActivationFile -logfile /dev/stdout -nographics || true
              cp /*.alf /output/ 2>/dev/null || true
              find / -name '*.alf' -exec cp {} /output/ \; 2>/dev/null || true
            "

          if ls *.alf 1>/dev/null 2>&1; then
            echo ""
            echo "ALF file generated successfully."
            echo "It will be uploaded as an artifact (NOT printed to logs)."
          else
            echo "ERROR: No .alf file was generated"
            exit 1
          fi

      - name: Upload ALF as artifact
        if: inputs.activation_method == 'manual'
        uses: actions/upload-artifact@v4
        with:
          name: unity-activation-request
          path: "*.alf"
          retention-days: 1
          if-no-files-found: error

      - name: Clean up ALF from runner
        if: inputs.activation_method == 'manual'
        run: rm -f *.alf

      - name: Manual activation instructions
        if: inputs.activation_method == 'manual'
        run: |
          echo ""
          echo "=============================================="
          echo "  NEXT STEPS"
          echo "=============================================="
          echo ""
          echo "1. Download 'unity-activation-request' artifact from this workflow run"
          echo "   Command: gh run download <run-id> -n unity-activation-request"
          echo ""
          echo "2. Go to: https://license.unity3d.com/manual"
          echo ""
          echo "3. Upload the .alf file"
          echo ""
          echo "4. If 'Personal' option is hidden:"
          echo "   - Press F12 to open DevTools"
          echo "   - Go to Elements tab, search for 'option-personal'"
          echo "   - Remove 'style=\"display: none;\"' from that div"
          echo ""
          echo "5. Download the generated .ulf file"
          echo ""
          echo "6. Set it as a secret (run locally, NOT in CI):"
          echo "   gh secret set UNITY_LICENSE --repo ${{ github.repository }} < Unity_v2022.x.ulf"
          echo ""
          echo "7. DELETE the artifact from this workflow run!"
          echo "   (Click on the run, scroll to Artifacts, click delete)"
          echo ""
          echo "8. Delete the .alf and .ulf files from your local machine"
          echo ""
          echo "=============================================="

      # =========================================================================
      # AUTOMATIC METHOD: Activate and set secret directly (no artifacts)
      # =========================================================================
      - name: Attempt automatic activation
        if: inputs.activation_method == 'automatic'
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attempting automatic Unity license activation..."
          echo "Note: This may fail if you have 2FA enabled"

          docker run --rm \
            -e UNITY_EMAIL="$UNITY_EMAIL" \
            -e UNITY_PASSWORD="$UNITY_PASSWORD" \
            -v $PWD:/output \
            unityci/editor:ubuntu-2022.3.61f1-linux-il2cpp-3 \
            bash -c "
              unity-editor -batchmode -nographics -logfile /dev/stdout \
                -username \"\$UNITY_EMAIL\" \
                -password \"\$UNITY_PASSWORD\" \
                -quit || true
              cp /root/.local/share/unity3d/Unity/*.ulf /output/ 2>/dev/null || true
              find /root -name '*.ulf' -exec cp {} /output/ \; 2>/dev/null || true
            "

          if ls *.ulf 1>/dev/null 2>&1; then
            echo ""
            echo "License file generated! Setting as secret..."
            # Set the secret directly - NEVER output or upload the content
            gh secret set UNITY_LICENSE --repo ${{ github.repository }} < *.ulf
            echo "SUCCESS: UNITY_LICENSE secret has been set!"
            # Clean up immediately
            rm -f *.ulf
            echo "License file deleted from runner."
          else
            echo ""
            echo "ERROR: Automatic activation failed."
            echo "This usually happens with 2FA enabled."
            echo "Please use the 'manual' method instead."
            exit 1
          fi

      - name: Final security reminder
        run: |
          echo ""
          echo "=============================================="
          echo "  SECURITY CHECKLIST"
          echo "=============================================="
          echo ""
          echo "[ ] Downloaded artifacts? Delete them from this run"
          echo "[ ] Have local .alf/.ulf files? Delete them"
          echo "[ ] Public repo? Verify no sensitive artifacts remain"
          echo "[ ] UNITY_LICENSE secret set? Verify in repo settings"
          echo ""
          echo "License files should ONLY exist as:"
          echo "  - UNITY_LICENSE GitHub Secret (encrypted)"
          echo ""
          echo "They should NEVER be:"
          echo "  - Committed to the repository"
          echo "  - Left as downloadable artifacts"
          echo "  - Shared publicly"
          echo "  - Stored unencrypted"
          echo ""
          echo "=============================================="
