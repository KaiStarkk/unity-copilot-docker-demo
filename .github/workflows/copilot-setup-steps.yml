# Unity Editor in Docker for GitHub Copilot Coding Agent
#
# This workflow demonstrates running Unity Editor in a Docker container
# that persists while GitHub Copilot coding agent works.
#
# Prerequisites:
# 1. Set up GitHub Secrets (see README.md):
#    - UNITY_LICENSE: Contents of your .ulf license file
#    - UNITY_EMAIL: Your Unity account email
#    - UNITY_PASSWORD: Your Unity account password
#
# References:
# - GameCI Activation: https://game.ci/docs/github/activation/
# - Copilot Setup Steps: https://docs.github.com/en/copilot/customizing-copilot/customizing-the-development-environment-for-copilot-coding-agent

name: Copilot Setup Steps

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/copilot-setup-steps.yml'
  pull_request:
    paths:
      - '.github/workflows/copilot-setup-steps.yml'

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 59
    permissions:
      contents: read

    steps:
      # ===========================================
      # Step 1: Checkout repository
      # ===========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===========================================
      # Step 2: Activate Unity License using GameCI
      # This handles machine binding properly for CI
      # ===========================================
      - name: Activate Unity License
        uses: game-ci/unity-activate@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      # ===========================================
      # Step 3: Prepare license file
      # ===========================================
      - name: Prepare license file
        run: |
          # Create license directory and write the license file
          mkdir -p /tmp/unity-license
          echo '${{ secrets.UNITY_LICENSE }}' > /tmp/unity-license/Unity_lic.ulf
          echo "License file prepared"

      # ===========================================
      # Step 4: Start Unity container with docker run -d
      # ===========================================
      - name: Start Unity Editor container
        run: |
          echo "Starting Unity Editor container..."

          # Start the Unity container in detached mode
          docker run -d \
            --name unity-editor \
            -p 8090:8090 \
            -v "${{ github.workspace }}/UnityProject:/project:rw" \
            -v "/tmp/unity-license:/root/.local/share/unity3d/Unity:rw" \
            unityci/editor:ubuntu-2022.3.61f1-linux-il2cpp-3 \
            /bin/bash -c "
              echo 'Unity container started'
              echo 'Waiting for commands...'
              # Keep container running
              tail -f /dev/null
            "

          # Wait for container to be ready
          sleep 5

          echo "Container started."
          docker ps

      # ===========================================
      # Step 5: Start Unity Editor inside the container
      # ===========================================
      - name: Start Unity Editor
        run: |
          echo "Starting Unity Editor in batch mode..."

          # Start Unity in background
          docker exec -d unity-editor /bin/bash -c "
            unity-editor \
              -batchmode \
              -nographics \
              -logFile /tmp/unity.log \
              -projectPath /project \
              -executeMethod Editor.Startup.Init \
              2>&1 &

            # Keep the exec running to monitor
            tail -f /tmp/unity.log 2>/dev/null || tail -f /dev/null
          "

          echo "Unity Editor starting..."

      # ===========================================
      # Step 6: Wait for Unity to initialize
      # ===========================================
      - name: Wait for Unity initialization
        run: |
          echo "Waiting for Unity Editor to initialize..."

          timeout=300
          elapsed=0

          while [ $elapsed -lt $timeout ]; do
            # Check if Unity process is running
            if docker exec unity-editor pgrep -f "Unity" > /dev/null 2>&1; then
              echo "Unity process detected!"

              # Check for initialization marker
              if docker exec unity-editor cat /tmp/unity.log 2>/dev/null | grep -q "Unity-MCP-Ready"; then
                echo "Unity MCP initialized successfully!"
                exit 0
              fi

              # Check for license errors
              if docker exec unity-editor cat /tmp/unity.log 2>/dev/null | grep -q "No valid Unity Editor license"; then
                echo "ERROR: License activation failed"
                docker exec unity-editor cat /tmp/unity.log | tail -50
                exit 1
              fi
            fi

            # Check if container is still running
            if ! docker ps | grep -q unity-editor; then
              echo "ERROR: Unity container stopped unexpectedly"
              docker logs unity-editor 2>&1 | tail -50
              exit 1
            fi

            sleep 10
            elapsed=$((elapsed + 10))
            echo "Waiting... ($elapsed/$timeout seconds)"

            # Show recent logs
            docker exec unity-editor tail -5 /tmp/unity.log 2>/dev/null || true
          done

          echo "Timeout reached. Checking final status..."
          docker exec unity-editor cat /tmp/unity.log 2>/dev/null | tail -100 || true

      # ===========================================
      # Step 7: Verify Unity is running
      # ===========================================
      - name: Verify Unity status
        run: |
          echo "=== Container Status ==="
          docker ps

          echo ""
          echo "=== Unity Process ==="
          docker exec unity-editor ps aux | grep -i unity || echo "No Unity process found"

          echo ""
          echo "=== Port Status ==="
          docker exec unity-editor netstat -tlnp 2>/dev/null | grep 8090 || echo "Port 8090 not bound yet"

          echo ""
          echo "=== Recent Logs ==="
          docker exec unity-editor tail -30 /tmp/unity.log 2>/dev/null || echo "No logs available"

          echo ""
          echo "Setup complete! Unity Editor container 'unity-editor' is running."
          echo "Access via: localhost:8090"
