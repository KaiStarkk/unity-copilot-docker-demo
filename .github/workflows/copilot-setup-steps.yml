# Unity Editor + MCP Server for GitHub Copilot Coding Agent
#
# This workflow sets up a complete Unity development environment with MCP
# integration for GitHub Copilot. After setup completes, Copilot can interact
# with Unity via the MCP protocol.
#
# Architecture:
#   ┌─────────────────────────────────────────────────────────────┐
#   │ GitHub Actions Runner                                       │
#   │                                                             │
#   │  ┌─────────────────┐     SignalR      ┌─────────────────┐  │
#   │  │ Unity Editor    │◄────────────────►│ Unity-MCP-Server│  │
#   │  │ + Unity-MCP     │   (Docker net)   │ (Service)       │  │
#   │  │   Plugin        │                  │ localhost:8080  │  │
#   │  └────────┬────────┘                  └────────▲────────┘  │
#   │           │                                    │            │
#   │           │ localhost:8090                     │ MCP        │
#   │           │                                    │            │
#   │           │                    ┌───────────────┴──────────┐ │
#   │           └───── Health ──────►│  GitHub Copilot Agent    │ │
#   │                                └──────────────────────────┘ │
#   └─────────────────────────────────────────────────────────────┘
#
# Prerequisites:
#   - UNITY_LICENSE: Contents of your .ulf license file
#   - UNITY_EMAIL: Your Unity account email
#   - UNITY_PASSWORD: Your Unity account password
#
# References:
#   - Copilot Setup: https://docs.github.com/en/copilot/customizing-copilot/customizing-the-development-environment-for-copilot-coding-agent
#   - Unity-MCP: https://github.com/IvanMurzak/Unity-MCP
#   - GameCI: https://game.ci/docs/github/activation/

name: Copilot Setup Steps

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/copilot-setup-steps.yml'
  pull_request:
    paths:
      - '.github/workflows/copilot-setup-steps.yml'

jobs:
  # IMPORTANT: Job name MUST be exactly 'copilot-setup-steps' for Copilot to recognize it
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 59
    permissions:
      contents: read

    # =========================================================================
    # SERVICE CONTAINERS
    # Services persist throughout the job and are accessible to Copilot
    # =========================================================================
    services:
      # Unity-MCP-Server: Bridges Copilot (MCP client) to Unity Editor
      # Accessible at localhost:8080 via MCP protocol
      mcp-server:
        image: ivanmurzakdev/unity-mcp-server:latest
        ports:
          - 8080:8080
        env:
          TRANSPORT: http
          # Unity container will be accessible at unity-editor:8090 on Docker network
          SIGNALR_URL: http://unity-editor:8090/unityhub
        # Note: No health check - the .NET container doesn't have curl/wget
        # The server logs "Start listening on port: 8080" when ready

    steps:
      # =========================================================================
      # SETUP PHASE
      # =========================================================================

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Activate Unity License
        uses: game-ci/unity-activate@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      # =========================================================================
      # DOCKER NETWORK SETUP
      # Connect service container and Unity container on same network
      # =========================================================================

      - name: Setup Docker networking
        run: |
          # Create a bridge network for Unity <-> MCP Server communication
          docker network create unity-mcp-net || true

          # Find the MCP server service container (started by GitHub Actions)
          MCP_CONTAINER=$(docker ps --filter "ancestor=ivanmurzakdev/unity-mcp-server" --format "{{.ID}}" | head -1)

          if [ -n "$MCP_CONTAINER" ]; then
            echo "Found MCP Server container: $MCP_CONTAINER"
            # Connect it to our custom network with a predictable alias
            docker network connect --alias mcp-server unity-mcp-net "$MCP_CONTAINER" 2>/dev/null || true
          else
            echo "Warning: MCP Server container not found yet"
          fi

      # =========================================================================
      # UNITY EDITOR CONTAINER
      # =========================================================================

      - name: Prepare Unity license
        run: |
          mkdir -p /tmp/unity-license
          # Copy GameCI activated license
          cp -r ~/.local/share/unity3d/Unity/. /tmp/unity-license/ 2>/dev/null || true
          # Also write secret as backup
          echo '${{ secrets.UNITY_LICENSE }}' > /tmp/unity-license/Unity_lic.ulf
          echo "License prepared in /tmp/unity-license/"
          ls -la /tmp/unity-license/

      - name: Start Unity Editor container
        run: |
          echo "Starting Unity Editor container..."

          docker run -d \
            --name unity-editor \
            --network unity-mcp-net \
            --network-alias unity-editor \
            -p 8090:8090 \
            -v "${{ github.workspace }}/UnityProject:/project:rw" \
            -v "/tmp/unity-license:/root/.local/share/unity3d/Unity:rw" \
            unityci/editor:ubuntu-2022.3.61f1-linux-il2cpp-3 \
            /bin/bash -c "tail -f /dev/null"

          sleep 3
          echo "Container started:"
          docker ps --filter name=unity-editor --format "table {{.ID}}\t{{.Status}}\t{{.Ports}}"

      - name: Start Unity Editor process
        run: |
          echo "Launching Unity Editor in batch mode..."

          docker exec -d unity-editor /bin/bash -c "
            unity-editor \
              -batchmode \
              -nographics \
              -logFile /tmp/unity.log \
              -projectPath /project \
              -executeMethod Editor.Startup.Init \
              2>&1 &
            tail -f /tmp/unity.log 2>/dev/null || tail -f /dev/null
          "

      # =========================================================================
      # INITIALIZATION WAIT
      # =========================================================================

      - name: Wait for Unity initialization
        run: |
          echo "Waiting for Unity Editor to initialize..."
          echo "This may take 2-5 minutes for first-time project import..."

          timeout=300
          elapsed=0

          while [ $elapsed -lt $timeout ]; do
            # Check if Unity process exists
            if docker exec unity-editor pgrep -f "Unity" > /dev/null 2>&1; then
              # Check for ready marker
              if docker exec unity-editor grep -q "Unity-MCP-Ready" /tmp/unity.log 2>/dev/null; then
                echo ""
                echo "Unity initialized successfully!"
                exit 0
              fi

              # Check for fatal errors
              if docker exec unity-editor grep -q "No valid Unity Editor license" /tmp/unity.log 2>/dev/null; then
                echo "ERROR: License activation failed!"
                docker exec unity-editor tail -50 /tmp/unity.log
                exit 1
              fi
            fi

            # Verify container health
            if ! docker ps --filter name=unity-editor --filter status=running -q | grep -q .; then
              echo "ERROR: Unity container stopped!"
              docker logs unity-editor 2>&1 | tail -30
              exit 1
            fi

            sleep 10
            elapsed=$((elapsed + 10))
            printf "Waiting... %d/%ds " "$elapsed" "$timeout"
            docker exec unity-editor tail -1 /tmp/unity.log 2>/dev/null | head -c 80 || true
            echo ""
          done

          echo "Warning: Timeout reached. Checking status..."
          docker exec unity-editor tail -30 /tmp/unity.log 2>/dev/null || true

      # =========================================================================
      # VERIFICATION
      # =========================================================================

      - name: Verify setup
        run: |
          echo "=========================================="
          echo "       COPILOT ENVIRONMENT READY"
          echo "=========================================="
          echo ""

          echo "Running Containers:"
          docker ps --format "  {{.Names}}: {{.Status}}"

          echo ""
          echo "Network (unity-mcp-net):"
          docker network inspect unity-mcp-net --format '{{range .Containers}}  {{.Name}}: {{.IPv4Address}}{{"\n"}}{{end}}' 2>/dev/null || echo "  (pending)"

          echo ""
          echo "Unity Status:"
          docker exec unity-editor pgrep -a Unity 2>/dev/null | head -1 || echo "  Process not found"

          echo ""
          echo "Port Bindings:"
          echo "  localhost:8080 -> MCP Server (Copilot connects here)"
          echo "  localhost:8090 -> Unity Health Check"

          echo ""
          echo "MCP Server Status:"
          curl -sf http://localhost:8080/help 2>/dev/null | head -3 || echo "  (checking port...)"
          nc -zv localhost 8080 2>&1 | grep -q succeeded && echo "  Port 8080: Open" || echo "  Port 8080: Closed"

          echo ""
          echo "Unity Logs (last 10 lines):"
          docker exec unity-editor tail -10 /tmp/unity.log 2>/dev/null | sed 's/^/  /' || echo "  No logs"

          echo ""
          echo "=========================================="
          echo "Copilot can now use Unity via MCP!"
          echo "  MCP endpoint: http://localhost:8080"
          echo "=========================================="
